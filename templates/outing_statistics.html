<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>외출 통계 - 김천고등학교 외출 관리 시스템</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="login-container">
    <div class="login-box">
        <header>
            <img src="{{ url_for('static', filename='gimgologo.png') }}" alt="김천고등학교 로고">
            <h1>외출 통계</h1>
        </header>

        <!-- 뒤로가기 버튼 -->
        <button class="button_normal" onclick="goBack()">뒤로가기</button>

        <!-- 외출 통계 표시 -->
        <canvas id="outingChart" style="display:none;"></canvas>

        <!-- 통계가 없을 경우 메시지 -->
        <div id="noDataMessage" style="display:none;">
            <h2>통계가 없습니다</h2>
        </div>

        <div id="classTableContainer" style="display:none;">
            <h2>학생별 외출 통계</h2>
            <table>
                <thead>
                    <tr>
                        <th>이름</th>
                        <th>외출 횟수</th>
                    </tr>
                </thead>
                <tbody id="classTableBody">
                    <!-- JavaScript로 데이터가 채워질 부분 -->
                </tbody>
            </table>
        </div>

        <button class="button_normal" onclick="confirmDeleteAll()">외출 신청 내역 초기화</button>
    </div>
</div>

<script>
    function goBack() {
        window.location.href = "{{ url_for('views.admin_page') }}";  // 관리자 페이지로 이동
    }

    let currentView = 'grade'; // 현재 보여주고 있는 뷰 상태 (grade or class)
    let selectedGrade = null;  // 선택된 학년
    const gradeStats = {{ stats|tojson }};
    let classStats = {}; // 학년 클릭 시 로드할 반별 통계 저장소

    const outingChart = document.getElementById('outingChart');
    const noDataMessage = document.getElementById('noDataMessage');
    let chart;  // 전역 변수로 정의

    if (gradeStats.length > 0) {
        outingChart.style.display = 'block';

        chart = new Chart(outingChart, {
            type: 'pie',
            data: {
                labels: gradeStats.map(s => `${s.grade}학년`),
                datasets: [{
                    label: '외출 승인 횟수',
                    data: gradeStats.map(s => s.count),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                    hoverOffset: 4
                }]
            },
            options: {
                onClick: (e, item) => {
                    if (item.length > 0) {
                        const index = item[0].index;
                        if (currentView === 'grade') {
                            selectedGrade = gradeStats[index].grade;
                            loadClassStatistics(selectedGrade);
                        } else if (currentView === 'class') {
                            const selectedClass = classStats[index].student_class;
                            loadStudentStatistics(selectedGrade, selectedClass);
                        }
                    }
                }
            }
        });
    } else {
        noDataMessage.style.display = 'block';
    }

    function loadClassStatistics(grade) {
        fetch(`/views/class_statistics?grade=${grade}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                classStats = data;
                currentView = 'class';

                if (classStats.length > 0) {
                    chart.data.labels = classStats.map(s => `${s.student_class}반`);
                    chart.data.datasets[0].data = classStats.map(s => s.count);
                    chart.update();
                } else {
                    noDataMessage.style.display = 'block';
                    outingChart.style.display = 'none';
                }
            })
            .catch(error => console.error('Error loading class statistics:', error));
    }

    function loadStudentStatistics(grade, studentClass) {
        fetch(`/views/student_statistics?grade=${grade}&class=${studentClass}`)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('classTableBody');
                tableBody.innerHTML = '';

                if (data.length > 0) {
                    data.forEach(student => {
                        const row = document.createElement('tr');
                        const nameCell = document.createElement('td');
                        const countCell = document.createElement('td');
                        nameCell.textContent = student.name;
                        countCell.textContent = student.count;
                        row.appendChild(nameCell);
                        row.appendChild(countCell);
                        tableBody.appendChild(row);
                    });
                    document.getElementById('classTableContainer').style.display = 'block';
                    outingChart.style.display = 'none';
                } else {
                    noDataMessage.style.display = 'block';
                    outingChart.style.display = 'none';
                }
            })
            .catch(error => console.error('Error loading student statistics:', error));
    }

    function confirmDeleteAll() {
        const adminPassword = prompt("외출 신청 내역을 초기화하려면 관리자 비밀번호를 입력하세요:");
        if (adminPassword !== null) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('views.delete_all_outing_requests') }}";
            const passwordInput = document.createElement('input');
            passwordInput.type = 'hidden';
            passwordInput.name = 'admin_password';
            passwordInput.value = adminPassword;
            form.appendChild(passwordInput);
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
</body>
</html>
